{% extends 'base.html' %}
{% block main %}
  <style>
    .group-chip {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      border: 1px solid #e5e7eb;
      font-size: 0.875rem;
      color: #4b5563;
      background-color: #ffffff;
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
      cursor: pointer;
    }
    .group-chip:hover {
      border-color: #cbd5f5;
      color: #111827;
    }
    .group-chip.active {
      background-color: rgb(22 93 255 / 1);
      border-color: rgb(22 93 255 / 1);
      color: #ffffff;
    }
    .group-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      color: #374151;
      background-color: #f3f4f6;
      line-height: 1.25rem;
    }
  </style>
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- 顶部导航栏 -->
      <header class="bg-white border-b border-gray-200 shadow-sm z-10">
        <div class="flex items-center justify-between h-16 px-6">
          <!-- 移动端菜单按钮 -->
          <button id="mobile-menu-btn" class="md:hidden text-gray-500 hover:text-gray-700">
            <i class="fa fa-bars text-xl"></i>
          </button>

          <!-- 搜索框 -->
          <div class="flex-1 max-w-md mx-4 hidden md:block">
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa fa-search text-gray-400"></i>
              </div>
              <input type="text" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm" placeholder="搜索规则、主机...">
            </div>
          </div>

          <!-- 右侧工具栏 -->
          <div class="flex items-center space-x-4">
            <button class="text-gray-500 hover:text-gray-700 relative"
                    onclick="window.location.href='/logout'">
              <span class="flex items-center">
                <i class="fa fa-sign-out text-xl mr-1"></i>
                <span class="text-sm">退出登录</span>
              </span>
            </button>
            <button class="text-gray-500 hover:text-gray-700">
              <i class="fa fa-question-circle text-xl"></i>
            </button>
            <div class="hidden md:block h-6 w-px bg-gray-300"></div>
            <button class="md:hidden text-gray-500 hover:text-gray-700">
              <i class="fa fa-search text-xl"></i>
            </button>
          </div>
        </div>
      </header>

      <!-- 页面内容 -->
      <main class="flex-1 overflow-y-auto bg-gray-50 p-6">
        <div class="container mx-auto max-w-7xl">
          <!-- 页面标题 -->
          <header class="mb-8">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark mb-2">防火墙规则管理</h1>
            <p class="text-secondary">管理和配置防火墙的访问控制规则</p>
          </header>

          <!-- 方向选择、主机信息和新增按钮区域 -->
          <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <!-- 方向选择 - 左侧 -->
            <div class="flex bg-white p-1 rounded-lg border border-gray-200 self-start md:self-auto">
            <a href="/rules_in?host_id={{ id }}">
              <button id="inbound-btn" class="px-4 py-2 rounded-md text-secondary font-medium hover:bg-gray-100 transition-colors">
                <i class="fa fa-sign-in mr-1"></i> 入方向
              </button>
            </a>
              <a href="/rules_out?host_id={{ id }}">
              <button id="outbound-btn" class="px-4 py-2 rounded-md text-secondary font-medium hover:bg-gray-100 transition-colors">
                <i class="fa fa-sign-out mr-1"></i> 出方向
              </button>
              </a>
            </div>

            <!-- 新增规则按钮 - 右侧 -->
            <button id="add-rule-btn" class="bg-primary text-white px-5 py-2.5 rounded-lg font-medium flex items-center btn-hover self-start md:self-auto ml-auto">
              <i class="fa fa-plus mr-2"></i> 新增规则
            </button>
          </div>

          <!-- 分组筛选 & 快捷操作 -->
          <div class="bg-white rounded-xl p-4 mb-4 border border-gray-100 shadow-sm">
            <div class="flex flex-col lg:flex-row lg:items-center gap-4">
              <div class="flex flex-wrap gap-2" id="group-filters">
                <button data-group="all" class="group-chip active">全部分组</button>
                {% for group in groups %}
                <button data-group="{{ group.name }}" class="group-chip">
                  {{ group.name }} <span class="ml-1 text-xs text-gray-500">{{ group.rule_count }}</span>
                </button>
                {% endfor %}
              </div>
              <div class="flex flex-wrap gap-3 ml-auto items-center">
                <select id="bulk-group-select" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
                  <option value="">选择目标分组</option>
                  {% for group in groups %}
                  <option value="{{ group.id }}">{{ group.name }}</option>
                  {% endfor %}
                </select>
                <button id="move-to-group-btn" class="px-4 py-2 bg-indigo-50 text-indigo-700 rounded-md text-sm">
                  <i class="fa fa-folder-open mr-1"></i> 移动到分组
                </button>
                <button id="batch-delete-btn" class="px-4 py-2 bg-red-50 text-red-600 rounded-md text-sm">
                  <i class="fa fa-trash mr-1"></i> 批量删除
                </button>
                <button id="create-group-btn" class="px-4 py-2 border border-gray-300 rounded-md text-sm">
                  <i class="fa fa-plus mr-1"></i> 新建分组
                </button>
              </div>
            </div>
          </div>

          <!-- 规则列表 -->
          <div class="bg-white rounded-xl table-shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="w-12 px-4 py-4">
                    <input type="checkbox" id="select-all-rules" class="form-checkbox">
                  </th>
                  <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-secondary uppercase tracking-wider">ID</th>
                  <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-secondary uppercase tracking-wider">授权策略</th>
                  <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-secondary uppercase tracking-wider">协议类型</th>
                  <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-secondary uppercase tracking-wider">端口</th>
                  <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-secondary uppercase tracking-wider">授权对象</th>
                  <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-secondary uppercase tracking-wider">描述</th>
                  <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-secondary uppercase tracking-wider">分组</th>
                  <th scope="col" class="px-6 py-4 text-right text-xs font-semibold text-secondary uppercase tracking-wider">操作</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
              {% for data in data_list %}
                <!-- 规则行：通过data-*属性存储规则数据 -->
                <tr class="hover:bg-gray-50 transition-colors"
                    data-num="{{ data.num }}"
                    data-target="{{ data.target }}"
                    data-prot="{{ data.prot }}"
                    data-port="{{ data.port }}"
                    data-source="{{ data.source }}"
                    data-comment="{{ data.comment }}"
                    data-limit="{{ data.limit }}"
                    data-hash="{{ data.rule_hash }}"
                    data-group-name="{{ data.group_name }}"
                    data-group-id="{{ data.group_id }}">
                  <td class="px-4 py-4 text-center">
                    <input type="checkbox" class="rule-select" data-num="{{ data.num }}" data-hash="{{ data.rule_hash }}">
                  </td>
                  <td class="data-num px-6 py-4 whitespace-nowrap text-sm font-medium text-dark">{{ data.num }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">
                    {% if data.target == 'ACCEPT' %}
                      <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-success">{{ data.target }}</span>
                    {% else %}
                      <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-danger">{{ data.target }}</span>
                    {% endif %}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary">{{ data.prot }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary">{{ data.port }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary">{{ data.source }}</td>
                  <!-- 描述列：合并限速信息和原有描述 -->
                  <td class="px-6 py-4 text-sm text-secondary">
                    {% if data.limit %}
                      <!-- 限速信息：带颜色图标 + 速率值 -->
                      <span class="inline-flex items-center mr-2" style="color: #3B82F6;">  <!-- 蓝色十六进制值 -->
                        <i class="fa fa-tachometer mr-1"></i>
                        {{ data.limit }}
                      </span>
                      <!-- 原有描述（如果存在则显示） -->
                      {% if data.comment %}
                        <span class="text-gray-600">- {{ data.comment }}</span>
                      {% endif %}
                    {% else %}
                      <!-- 无限速时仅显示原有描述 -->
                      {{ data.comment or '' }}
                    {% endif %}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="group-badge">{{ data.group_name }}</span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button class="edit-btn text-info hover:text-primary mr-3 transition-colors">
                      <i class="fa fa-pencil"></i> 编辑
                    </button>
                    <button class="delete-btn text-danger hover:text-red-700 transition-colors">
                      <i class="fa fa-trash"></i> 删除
                    </button>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
    </div>
  </div>
      </main>

  <!-- 模态框 - 新增/编辑规则 -->
  <div id="rule-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all">
      <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg font-semibold" id="modal-title">新增规则</h3>
        <button id="close-modal" class="text-gray-400 hover:text-gray-500">
          <i class="fa fa-times"></i>
        </button>
      </div>

      <div class="px-6 py-5">
        <form id="rule-form">
          <input type="hidden" id="rule-hash" name="rule-hash">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label for="rule-id" class="block text-sm font-medium text-gray-700 mb-1">ID</label>
              <input type="text" id="rule-id" name="rule-id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="自动生成">
            </div>

            <div>
              <label for="auth-policy" class="block text-sm font-medium text-gray-700 mb-1">授权策略</label>
              <select id="auth-policy" name="auth-policy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                <option value="ACCEPT">允许</option>
                <option value="DROP">拒绝</option>
              </select>
            </div>

            <div>
              <label for="protocol" class="block text-sm font-medium text-gray-700 mb-1">协议类型</label>
              <select id="protocol" name="protocol" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                <option value="tcp">TCP</option>
                <option value="udp">UDP</option>
                <option value="icmp">ICMP</option>
                <option value="all">全部</option>
              </select>
            </div>

            <div>
              <label for="port" class="block text-sm font-medium text-gray-700 mb-1">端口</label>
              <input type="text" id="port" name="port" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="例如: 80 或 100-200">
            </div>

            <div class="md:col-span-2">
              <label for="auth-object" class="block text-sm font-medium text-gray-700 mb-1">授权对象</label>
              <input type="text" id="auth-object" name="auth-object" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="IP地址或网段，例如: 192.168.1.0/24">
            </div>

            <div>
              <label for="rule-group" class="block text-sm font-medium text-gray-700 mb-1">规则分组</label>
              <select id="rule-group" name="rule-group" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                {% for group in groups %}
                <option value="{{ group.id }}">{{ group.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- 限速输入框（一直显示） -->
            <div id="speed-limit-container" class="md:col-span-2">
              <label for="speed-limit" class="block text-sm font-medium text-gray-700 mb-1">限制速率（kb/s，留空表示不限速）</label>
              <div class="flex items-center">
                <input type="number" id="speed-limit" name="speed-limit" min="1" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="输入速率值">
                <span class="ml-2 text-gray-700">kb/s</span>
              </div>
            </div>

            <div class="md:col-span-2">
              <label for="description" class="block text-sm font-medium text-gray-700 mb-1">描述</label>
              <textarea id="description" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="规则描述信息"></textarea>
            </div>
          </div>
        </form>
      </div>

      <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end space-x-3">
        <button id="cancel-btn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 transition-colors">取消</button>
        <button id="save-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">保存</button>
      </div>
    </div>
  </div>

  <!-- 新建分组模态框 -->
  <div id="group-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl w-full max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">新建规则分组</h3>
        <button id="close-group-modal" class="text-gray-400 hover:text-gray-500">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="space-y-4">
        <div>
          <label for="new-group-name" class="block text-sm font-medium text-gray-700 mb-1">分组名称</label>
          <input type="text" id="new-group-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="例如：Web服务端口">
        </div>
      </div>
      <div class="mt-6 flex justify-end gap-3">
        <button id="cancel-group-btn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">取消</button>
        <button id="confirm-group-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90">创建</button>
      </div>
    </div>
  </div>
  <!-- 提示消息 -->
  <div id="success-toast" class="toast bg-success text-white translate-x-full">
    <i class="fa fa-check-circle mr-2"></i>
    <span>操作成功！</span>
  </div>
  <div id="error-toast" class="toast bg-danger text-white translate-x-full">
    <i class="fa fa-times-circle mr-2"></i>
    <span>操作失败，请重试！</span>
  </div>
{% endblock main %}


{% block script %}
  <script>
    const hostId = {{ id|tojson }};
    const currentDirection = {{ direction|default('INPUT')|tojson }};
    let groups = {{ groups|tojson }};
    let isEditing = false;

    const inboundBtn = document.getElementById('inbound-btn');
    const outboundBtn = document.getElementById('outbound-btn');
    const ruleModal = document.getElementById('rule-modal');
    const addRuleBtn = document.getElementById('add-rule-btn');
    const closeModalBtn = document.getElementById('close-modal');
    const cancelBtn = document.getElementById('cancel-btn');
    const saveBtn = document.getElementById('save-btn');
    const modalTitle = document.getElementById('modal-title');
    const ruleForm = document.getElementById('rule-form');
    const ruleIdInput = document.getElementById('rule-id');
    const authPolicySelect = document.getElementById('auth-policy');
    const protocolSelect = document.getElementById('protocol');
    const portInput = document.getElementById('port');
    const authObjectInput = document.getElementById('auth-object');
    const descriptionTextarea = document.getElementById('description');
    const speedLimitInput = document.getElementById('speed-limit');
    const ruleGroupSelect = document.getElementById('rule-group');
    const ruleHashInput = document.getElementById('rule-hash');
    const selectAllCheckbox = document.getElementById('select-all-rules');
    const groupFilters = document.getElementById('group-filters');
    const bulkGroupSelect = document.getElementById('bulk-group-select');
    const moveToGroupBtn = document.getElementById('move-to-group-btn');
    const batchDeleteBtn = document.getElementById('batch-delete-btn');
    const createGroupBtn = document.getElementById('create-group-btn');
    const groupModal = document.getElementById('group-modal');
    const closeGroupModalBtn = document.getElementById('close-group-modal');
    const cancelGroupBtn = document.getElementById('cancel-group-btn');
    const confirmGroupBtn = document.getElementById('confirm-group-btn');
    const newGroupNameInput = document.getElementById('new-group-name');
    const selectedRules = new Map();

    function setActiveDirection() {
      if (currentDirection === 'INPUT') {
        inboundBtn.classList.add('bg-primary', 'text-white');
      } else {
        outboundBtn.classList.add('bg-primary', 'text-white');
      }
    }

    function showToast(elementId) {
      const toast = document.getElementById(elementId);
      toast.classList.remove('translate-x-full');
      setTimeout(() => toast.classList.add('translate-x-full'), 2500);
    }

    function getDefaultGroupId() {
      const defaultGroup = groups.find(g => g.is_default);
      return defaultGroup ? defaultGroup.id : (groups[0] ? groups[0].id : '');
    }

    function populateGroupSelects() {
      if (!ruleGroupSelect || !bulkGroupSelect) return;
      ruleGroupSelect.innerHTML = '';
      bulkGroupSelect.innerHTML = '<option value="">选择目标分组</option>';
      groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.id;
        option.textContent = group.name;
        ruleGroupSelect.appendChild(option);
        const bulkOption = document.createElement('option');
        bulkOption.value = group.id;
        bulkOption.textContent = group.name;
        bulkGroupSelect.appendChild(bulkOption);
      });
      const defaultId = getDefaultGroupId();
      if (defaultId) {
        ruleGroupSelect.value = defaultId;
      }
    }

    function renderGroupFilters(activeName = 'all') {
      if (!groupFilters) return;
      groupFilters.innerHTML = '';
      const allBtn = document.createElement('button');
      allBtn.dataset.group = 'all';
      allBtn.textContent = '全部分组';
      allBtn.className = 'group-chip';
      if (activeName === 'all') allBtn.classList.add('active');
      groupFilters.appendChild(allBtn);
      groups.forEach(group => {
        const btn = document.createElement('button');
        btn.dataset.group = group.name;
        btn.className = 'group-chip';
        if (activeName === group.name) btn.classList.add('active');
        btn.innerHTML = `${group.name} <span class="ml-1 text-xs text-gray-500">${group.rule_count}</span>`;
        groupFilters.appendChild(btn);
      });
    }

    function filterRowsByGroup(groupName) {
      document.querySelectorAll('tbody tr').forEach(row => {
        if (groupName === 'all' || row.dataset.groupName === groupName) {
          row.classList.remove('hidden');
        } else {
          row.classList.add('hidden');
        }
      });
    }

    function toggleRowSelection(checkbox) {
      const hash = checkbox.dataset.hash;
      const row = checkbox.closest('tr');
      if (checkbox.checked) {
        selectedRules.set(hash, { num: checkbox.dataset.num, row });
        row.classList.add('bg-primary/5');
      } else {
        selectedRules.delete(hash);
        row.classList.remove('bg-primary/5');
      }
      updateBulkActionState();
    }

    function updateBulkActionState() {
      const hasSelection = selectedRules.size > 0;
      moveToGroupBtn.disabled = !hasSelection;
      batchDeleteBtn.disabled = !hasSelection;
    }

    function openRuleModal(title) {
      modalTitle.textContent = title;
      ruleModal.classList.remove('hidden');
      setTimeout(() => {
        ruleModal.querySelector('div').classList.add('scale-100');
        ruleModal.querySelector('div').classList.remove('scale-95');
      }, 10);
    }

    function closeRuleModal() {
      ruleModal.querySelector('div').classList.remove('scale-100');
      ruleModal.querySelector('div').classList.add('scale-95');
      setTimeout(() => {
        ruleModal.classList.add('hidden');
      }, 200);
    }

    function openGroupModal() {
      newGroupNameInput.value = '';
      groupModal.classList.remove('hidden');
    }

    function closeGroupModal() {
      groupModal.classList.add('hidden');
    }

    function resetRuleForm() {
      ruleForm.reset();
      ruleHashInput.value = '';
      const defaultId = getDefaultGroupId();
      if (defaultId) {
        ruleGroupSelect.value = defaultId;
      }
    }

    async function jsonFetch(url, options = {}) {
      const response = await fetch(url, {
        headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
        ...options
      });
      const result = await response.json();
      if (!response.ok || result.success === false) {
        throw new Error(result.message || '请求失败');
      }
      return result;
    }

    addRuleBtn.addEventListener('click', () => {
      isEditing = false;
      resetRuleForm();
      ruleIdInput.value = document.querySelectorAll('tbody tr').length + 1;
      ruleIdInput.disabled = false;
      openRuleModal('新增规则');
    });

    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const row = btn.closest('tr');
        isEditing = true;
        ruleIdInput.value = row.dataset.num;
        ruleIdInput.disabled = true;
        authPolicySelect.value = row.dataset.target;
        protocolSelect.value = row.dataset.prot;
        portInput.value = row.dataset.port;
        authObjectInput.value = row.dataset.source;
        descriptionTextarea.value = row.dataset.comment;
        ruleGroupSelect.value = row.dataset.groupId || getDefaultGroupId();
        ruleHashInput.value = row.dataset.hash || '';
        speedLimitInput.value = row.dataset.limit ? row.dataset.limit.replace(/kb\/s$/i, '').trim() : '';
        openRuleModal('编辑规则');
      });
    });

    closeModalBtn.addEventListener('click', closeRuleModal);
    cancelBtn.addEventListener('click', closeRuleModal);
    ruleModal.addEventListener('click', (e) => {
      if (e.target === ruleModal) closeRuleModal();
    });

    if (createGroupBtn) {
      createGroupBtn.addEventListener('click', openGroupModal);
    }
    closeGroupModalBtn.addEventListener('click', closeGroupModal);
    cancelGroupBtn.addEventListener('click', closeGroupModal);

    confirmGroupBtn.addEventListener('click', async () => {
      const name = newGroupNameInput.value.trim();
      if (!name) {
        alert('请输入分组名称');
        return;
      }
      try {
        const result = await jsonFetch(`/api/hosts/${hostId}/rule-groups`, {
          method: 'POST',
          body: JSON.stringify({ name, direction: currentDirection })
        });
        groups = result.data;
        populateGroupSelects();
        renderGroupFilters();
        closeGroupModal();
        showToast('success-toast');
      } catch (error) {
        console.error(error);
        showToast('error-toast');
      }
    });

    saveBtn.addEventListener('click', async () => {
      const payload = {
        host_id: hostId,
        direction: currentDirection,
        rule_id: ruleIdInput.value,
        auth_policy: authPolicySelect.value,
        protocol: protocolSelect.value,
        port: portInput.value,
        auth_object: authObjectInput.value,
        description: descriptionTextarea.value,
        limit: speedLimitInput.value.trim() ? `${speedLimitInput.value.trim()}kb/s` : '',
        group_id: ruleGroupSelect.value,
        rule_hash: ruleHashInput.value
      };
      const url = isEditing ? '/rules_update' : '/rules_add';
      try {
        await jsonFetch(url, { method: 'POST', body: JSON.stringify(payload) });
        showToast('success-toast');
        setTimeout(() => window.location.reload(), 800);
      } catch (error) {
        console.error(error);
        showToast('error-toast');
      }
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('确定要删除这条规则吗？')) return;
        const row = btn.closest('tr');
        const ruleNum = row.dataset.num;
        const ruleHash = row.dataset.hash;
        try {
          await jsonFetch(`/rule_del?host_id=${hostId}&rule_id=${ruleNum}&direction=${currentDirection}&rule_hash=${ruleHash}`, {
            method: 'DELETE'
          });
          row.remove();
          showToast('success-toast');
        } catch (error) {
          console.error(error);
          showToast('error-toast');
        }
      });
    });

    document.querySelectorAll('.rule-select').forEach(cb => {
      cb.addEventListener('change', () => toggleRowSelection(cb));
    });

    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', () => {
        document.querySelectorAll('.rule-select').forEach(cb => {
          cb.checked = selectAllCheckbox.checked;
          toggleRowSelection(cb);
        });
      });
    }

    if (groupFilters) {
      groupFilters.addEventListener('click', (e) => {
        const btn = e.target.closest('.group-chip');
        if (!btn) return;
        groupFilters.querySelectorAll('.group-chip').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        filterRowsByGroup(btn.dataset.group);
      });
    }

    moveToGroupBtn.addEventListener('click', async () => {
      if (selectedRules.size === 0) {
        alert('请先选择需要调整的规则');
        return;
      }
      if (!bulkGroupSelect.value) {
        alert('请选择目标分组');
        return;
      }
      try {
        const result = await jsonFetch(`/api/hosts/${hostId}/rules/group`, {
          method: 'POST',
          body: JSON.stringify({
            direction: currentDirection,
            group_id: bulkGroupSelect.value,
            rule_hashes: Array.from(selectedRules.keys())
          })
        });
        groups = result.data;
        const targetGroup = groups.find(g => g.id == bulkGroupSelect.value);
        selectedRules.forEach(({ row }) => {
          row.dataset.groupId = bulkGroupSelect.value;
          row.dataset.groupName = targetGroup ? targetGroup.name : row.dataset.groupName;
          row.querySelector('.group-badge').textContent = row.dataset.groupName;
          row.classList.remove('bg-primary/5');
          row.querySelector('.rule-select').checked = false;
        });
        selectedRules.clear();
        updateBulkActionState();
        populateGroupSelects();
        renderGroupFilters(groupFilters.querySelector('.group-chip.active')?.dataset.group || 'all');
        showToast('success-toast');
      } catch (error) {
        console.error(error);
        showToast('error-toast');
      }
    });

    batchDeleteBtn.addEventListener('click', async () => {
      if (selectedRules.size === 0) {
        alert('请选择需要删除的规则');
        return;
      }
      if (!confirm('确定删除选中的规则吗？')) return;
      try {
        const result = await jsonFetch(`/api/hosts/${hostId}/rules/batch-delete`, {
          method: 'POST',
          body: JSON.stringify({
            direction: currentDirection,
            rule_ids: Array.from(selectedRules.values()).map(item => item.num),
            rule_hashes: Array.from(selectedRules.keys())
          })
        });
        selectedRules.forEach(({ row }) => row.remove());
        selectedRules.clear();
        updateBulkActionState();
        if (result?.data) {
          groups = result.data;
          populateGroupSelects();
          const activeGroup = groupFilters?.querySelector('.group-chip.active')?.dataset.group || 'all';
          renderGroupFilters(activeGroup);
          filterRowsByGroup(activeGroup);
        }
        showToast('success-toast');
      } catch (error) {
        console.error(error);
        showToast('error-toast');
      }
    });

    populateGroupSelects();
    renderGroupFilters();
    filterRowsByGroup('all');
    setActiveDirection();
    updateBulkActionState();
  </script>
{% endblock script %}